<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Milestone #2 &#8212; MPCS 51082 - Introduction to Unix Systems  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../_static/bootstrap-sphinx.css?v=0bf093e7" />
    <link rel="stylesheet" type="text/css" href="../../_static/chiweb.css?v=9805d56b" />
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
    <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script defer="defer" src="../../_static/rmsearch.js?v=9704a757"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../../_static/js/jquery-1.12.4.min.js"></script>
<script type="text/javascript" src="../../_static/js/jquery-fix.js"></script>
<script type="text/javascript" src="../../_static/bootstrap-3.4.1/js/bootstrap.min.js"></script>
<script type="text/javascript" src="../../_static/bootstrap-sphinx.js"></script>

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../index.html">
          MPCS 51082</a>
        <span class="navbar-text navbar-version pull-left"><b></b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../../syllabus.html">Syllabus</a></li>
                <li><a href="../../calendar.html">Calendar</a></li>
                <li><a href="../../modules/index.html">Modules</a></li>
                <li><a href="../index.html">Assignments</a></li>
                <li><a href="../../office-hours.html">Office Hours</a></li>
                <li><a href="https://uchicago-cs.github.io/student-resource-guide/">CS Student Resources</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"></ul>
</li>
              
            
            
              
                
              
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
      <div class="col-md-3">
        <div id="sidebar" class="bs-sidenav" role="complementary"><ul>
<li><a class="reference internal" href="#">Milestone #2</a><ul>
<li><a class="reference internal" href="#cs-linux-machine">CS Linux Machine</a></li>
<li><a class="reference internal" href="#creating-your-private-repository">Creating Your Private Repository</a><ul>
<li><a class="reference internal" href="#task-1-update-the-msh-state">Task 1: Update the <code class="docutils literal notranslate"><span class="pre">msh</span></code> state</a></li>
<li><a class="reference internal" href="#task-2-signal-handlers-module-signal-handlers-h-and-signal-handlers-c">Task 2: Signal Handlers Module (<code class="docutils literal notranslate"><span class="pre">signal_handlers.h</span></code> and <code class="docutils literal notranslate"><span class="pre">signal_handlers.c</span></code>)</a><ul>
<li><a class="reference internal" href="#process-completion-status">Process Completion Status</a></li>
</ul>
</li>
<li><a class="reference internal" href="#optional-task-history-module-history-h-and-history-c-extra-credit-towards-your-exam-scores">Optional Task: History Module (<code class="docutils literal notranslate"><span class="pre">history.h</span></code> and <code class="docutils literal notranslate"><span class="pre">history.c</span></code>) (Extra Credit towards your Exam scores)</a><ul>
<li><a class="reference internal" href="#alloc-history-function"><code class="docutils literal notranslate"><span class="pre">alloc_history</span></code> function</a></li>
<li><a class="reference internal" href="#add-line-history-function"><code class="docutils literal notranslate"><span class="pre">add_line_history</span></code> function</a></li>
<li><a class="reference internal" href="#print-history-function"><code class="docutils literal notranslate"><span class="pre">print_history</span></code> function</a></li>
<li><a class="reference internal" href="#find-line-history-function"><code class="docutils literal notranslate"><span class="pre">find_line_history</span></code> function</a></li>
<li><a class="reference internal" href="#free-history-function"><code class="docutils literal notranslate"><span class="pre">free_history</span></code> function</a></li>
<li><a class="reference internal" href="#testing-the-history-module">Testing the <code class="docutils literal notranslate"><span class="pre">history</span></code> module</a></li>
<li><a class="reference internal" href="#update-the-evaluate-function">Update the <code class="docutils literal notranslate"><span class="pre">evaluate</span></code> function</a></li>
</ul>
</li>
<li><a class="reference internal" href="#task-3-built-in-commands">Task 3: Built-in Commands</a></li>
</ul>
</li>
<li><a class="reference internal" href="#hints-tips">Hints &amp; Tips</a><ul>
<li><a class="reference internal" href="#testing">Testing</a></li>
<li><a class="reference internal" href="#grading">Grading</a></li>
<li><a class="reference internal" href="#submission">Submission</a></li>
</ul>
</li>
</ul>
</li>
</ul>

<div id="sourcelink">
  <a href="../../_sources/assignments/milestone2/index.rst.txt"
     rel="nofollow">Source</a>
</div>
        </div>
      </div>
    <div class="body col-md-9 content" role="main">
      
  <section id="milestone-2">
<h1>Milestone #2<a class="headerlink" href="#milestone-2" title="Link to this heading">¶</a></h1>
<p><strong>Due: Friday, Decemeber 12th at 11:59pm</strong></p>
<p><strong>No extensions can be used for this final milestone!</strong></p>
<p>In this assignment, we will wrap up our shell implementation by implementing signals to handle job control and a few built-in shell commands.</p>
<section id="cs-linux-machine">
<h2>CS Linux Machine<a class="headerlink" href="#cs-linux-machine" title="Link to this heading">¶</a></h2>
<p>You will need access to an Linux based machine when working on your homework assignments. You should not test your programs on macOS or
Windows Linux because these operating systems do not provide all utility commands necessary for completing this and possibly future assignments.
Additionally, if they do provide a command then it may not contain all options that a Unix-like system provides.
<strong>We will use and grade all assignments on the CS Linux machines and all programming assignments must work correctly on these machines.</strong>
However, you can work locally on a Unix or Unix-like machine but ensure that you test your final solutions on a CS Linux machine.</p>
<p>Please follow the instructions provided here</p>
<ul class="simple">
<li><p><a class="reference external" href="https://uchicago-cs.github.io/student-resource-guide/vscode/ssh.html">Using Visual Studio Code and SSH</a></p></li>
</ul>
</section>
<section id="creating-your-private-repository">
<h2>Creating Your Private Repository<a class="headerlink" href="#creating-your-private-repository" title="Link to this heading">¶</a></h2>
<p>There is no new repository to create for this assignment. You will continue to use the repository you created in milestone #1.</p>
<section id="task-1-update-the-msh-state">
<h3>Task 1: Update the <code class="docutils literal notranslate"><span class="pre">msh</span></code> state<a class="headerlink" href="#task-1-update-the-msh-state" title="Link to this heading">¶</a></h3>
<p>In this assignment, the signal handlers will notify your shell when a child process terminates. The shell <code class="docutils literal notranslate"><span class="pre">msh_t</span> <span class="pre">*shell</span></code> variable now needs to be global to allow the signal handlers to access it. Most likely, many of you defined the <code class="docutils literal notranslate"><span class="pre">msh_t</span> <span class="pre">*shell</span></code> variable as a local variable of the <code class="docutils literal notranslate"><span class="pre">main</span></code> function; however, it nows needs to be global. First step, is to define it as an external variable inside <code class="docutils literal notranslate"><span class="pre">shell.h</span></code> (<strong>the following code should already be done for you!</strong>) as such</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="k">extern</span><span class="w"> </span><span class="n">msh_t</span><span class="w"> </span><span class="o">*</span><span class="n">shell</span><span class="p">;</span>
</pre></div>
</div>
<p>and then inside <code class="docutils literal notranslate"><span class="pre">shell.c</span></code> define it to be equal to <code class="docutils literal notranslate"><span class="pre">NULL</span></code> as such:</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="n">msh_t</span><span class="w"> </span><span class="o">*</span><span class="n">shell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</pre></div>
</div>
<p>This is now a global variable so make sure it’s define towards the top of those files. <strong>Make sure to remove the local variable declaration for ``msh_t *shell`` defined in your ``msh.c`` file! This only applies to those students who did this previously in milestone 1. Hopefully, most of you, are already using the global variable declaration.</strong></p>
</section>
<section id="task-2-signal-handlers-module-signal-handlers-h-and-signal-handlers-c">
<h3>Task 2: Signal Handlers Module (<code class="docutils literal notranslate"><span class="pre">signal_handlers.h</span></code> and <code class="docutils literal notranslate"><span class="pre">signal_handlers.c</span></code>)<a class="headerlink" href="#task-2-signal-handlers-module-signal-handlers-h-and-signal-handlers-c" title="Link to this heading">¶</a></h3>
<p>Currently, the way we  do not handle background jobs; therefore, we will update this code to use <em>signals</em>, which is the mechanism used to make background jobs work. To help you get started, we have provided the skeleton code for signal handling. Create and copy the following code into the <code class="docutils literal notranslate"><span class="pre">include/signal_handlers.h</span></code> file:</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="cp">#ifndef _SIGNAL_HANDLERS_H_</span>
<span class="cp">#define _SIGNAL_HANDLERS_H_</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">initialize_signal_handlers</span><span class="p">();</span>

<span class="cp">#endif</span>
</pre></div>
</div>
<p>You shouldn’t need to add any additional functions here but you can if you wish. Create and copy the starter implementation into <code class="docutils literal notranslate"><span class="pre">src/signal_handlers.c</span></code>:</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;signal_handlers.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;unistd.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;ctype.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;signal.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;errno.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>

<span class="cm">/*</span>
<span class="cm">* sigchld_handler - The kernel sends a SIGCHLD to the shell whenever</span>
<span class="cm">*     a child job terminates (becomes a zombie), or stops because it</span>
<span class="cm">*     received a SIGSTOP or SIGTSTP signal. The handler reaps all</span>
<span class="cm">*     available zombie children, but doesn&#39;t wait for any other</span>
<span class="cm">*     currently running children to terminate.</span>
<span class="cm">* Citation: Bryant and O’Hallaron, Computer Systems: A Programmer’s Perspective, Third Edition</span>
<span class="cm">*/</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">sigchld_handler</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">sig</span><span class="p">)</span>
<span class="p">{</span>


<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">* sigint_handler - The kernel sends a SIGINT to the shell whenver the</span>
<span class="cm">*    user types ctrl-c at the keyboard.  Catch it and send it along</span>
<span class="cm">*    to the foreground job.</span>
<span class="cm">* Citation: Bryant and O’Hallaron, Computer Systems: A Programmer’s Perspective, Third Edition</span>
<span class="cm">*/</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">sigint_handler</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">sig</span><span class="p">)</span>
<span class="p">{</span>


<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">* sigtstp_handler - The kernel sends a SIGTSTP to the shell whenever</span>
<span class="cm">*     the user types ctrl-z at the keyboard. Catch it and suspend the</span>
<span class="cm">*     foreground job by sending it a SIGTSTP.</span>
<span class="cm">* Citation: Bryant and O’Hallaron, Computer Systems: A Programmer’s Perspective, Third Edition</span>
<span class="cm">*/</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">sigtstp_handler</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">sig</span><span class="p">)</span>
<span class="p">{</span>


<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">* setup_handler - wrapper for the sigaction function</span>
<span class="cm">*</span>
<span class="cm">* Citation: Bryant and O’Hallaron, Computer Systems: A Programmer’s Perspective, Third Edition</span>
<span class="cm">*/</span>
<span class="k">typedef</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">handler_t</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>
<span class="n">handler_t</span><span class="w"> </span><span class="o">*</span><span class="nf">setup_handler</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">signum</span><span class="p">,</span><span class="w"> </span><span class="n">handler_t</span><span class="w"> </span><span class="o">*</span><span class="n">handler</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sigaction</span><span class="w"> </span><span class="n">action</span><span class="p">,</span><span class="w"> </span><span class="n">old_action</span><span class="p">;</span>

<span class="w">    </span><span class="n">action</span><span class="p">.</span><span class="n">sa_handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">handler</span><span class="p">;</span>
<span class="w">    </span><span class="n">sigemptyset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">action</span><span class="p">.</span><span class="n">sa_mask</span><span class="p">);</span><span class="w"> </span><span class="cm">/* block sigs of type being handled */</span>
<span class="w">    </span><span class="n">action</span><span class="p">.</span><span class="n">sa_flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SA_RESTART</span><span class="p">;</span><span class="w"> </span><span class="cm">/* restart syscalls if possible */</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sigaction</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">action</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">old_action</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">perror</span><span class="p">(</span><span class="s">&quot;Signal error&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">old_action</span><span class="p">.</span><span class="n">sa_handler</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">void</span><span class="w"> </span><span class="nf">initialize_signal_handlers</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="c1">// sigint handler: Catches SIGINT (ctrl-c) signals.</span>
<span class="w">    </span><span class="n">setup_handler</span><span class="p">(</span><span class="n">SIGINT</span><span class="p">,</span><span class="w">  </span><span class="n">sigint_handler</span><span class="p">);</span><span class="w">   </span><span class="cm">/* ctrl-c */</span>
<span class="w">    </span><span class="c1">// sigtstp handler: Catches SIGTSTP (ctrl-z) signals.</span>
<span class="w">    </span><span class="n">setup_handler</span><span class="p">(</span><span class="n">SIGTSTP</span><span class="p">,</span><span class="w"> </span><span class="n">sigtstp_handler</span><span class="p">);</span><span class="w">  </span><span class="cm">/* ctrl-z */</span>
<span class="w">    </span><span class="c1">// sigchld handler: Catches SIGCHILD signals.</span>
<span class="w">    </span><span class="n">setup_handler</span><span class="p">(</span><span class="n">SIGCHLD</span><span class="p">,</span><span class="w"> </span><span class="n">sigchld_handler</span><span class="p">);</span><span class="w">  </span><span class="cm">/* Terminated or stopped child */</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Update your <code class="docutils literal notranslate"><span class="pre">alloc_shell</span></code> function to call <code class="docutils literal notranslate"><span class="pre">initialize_signal_handlers</span></code> to setup the signal handlers. Read over the documentation above each signal handler code to make sure you understand when those functions will be called. Additionally, make sure to watch the pre-recorded videos on signals because they provide insight about how to think about implementing these functions.</p>
<p>You <strong>must</strong> remove the code in <code class="docutils literal notranslate"><span class="pre">evaluate</span></code> that deletes the foreground jobs. The signal handlers will now handle the updating of job list based on when a child process exits. Add code that handles background jobs. As reminder the parent process (i.e., the shell), does not wait for the background process to complete but rather continues to allow the user to enter another command after it forks the background process. One important note is that our shell must not <code class="docutils literal notranslate"><span class="pre">exit</span></code> until all background jobs complete. Make sure to still include this requirement in your code.</p>
<section id="process-completion-status">
<h4>Process Completion Status<a class="headerlink" href="#process-completion-status" title="Link to this heading">¶</a></h4>
<p>Inside the <code class="docutils literal notranslate"><span class="pre">sigchld_handler</span></code> function, it’s going to be important that you understand the process completion status so you know how to update the your <code class="docutils literal notranslate"><span class="pre">shell</span></code> state. Please make sure to read over these functions defined here:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.gnu.org/software/libc/manual/html_node/Process-Completion-Status.html">Process Completion Status</a></p></li>
</ul>
<p>Specifically, the ones you should pay close attention to are the following:</p>
<ul class="simple">
<li><p>WIFSTOPPED</p></li>
<li><p>WIFSIGNALED</p></li>
<li><p>WIFCONTINUED</p></li>
<li><p>WIFEXITED</p></li>
</ul>
<p>Additionally, when you are calling <code class="docutils literal notranslate"><span class="pre">waitpid</span></code> inside <code class="docutils literal notranslate"><span class="pre">sigchld_handler</span></code> make sure you understand the options that you can supply to it. Documentation is here:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.gnu.org/software/libc/manual/html_node/Process-Completion.html">Process Completion(waitpid)</a></p></li>
</ul>
<p>Pay close attention to the following options:</p>
<ul class="simple">
<li><p>WNOHANG</p></li>
<li><p>WUNTRACED</p></li>
<li><p>WCONTINUED</p></li>
</ul>
</section>
</section>
<section id="optional-task-history-module-history-h-and-history-c-extra-credit-towards-your-exam-scores">
<h3>Optional Task: History Module (<code class="docutils literal notranslate"><span class="pre">history.h</span></code> and <code class="docutils literal notranslate"><span class="pre">history.c</span></code>) (Extra Credit towards your Exam scores)<a class="headerlink" href="#optional-task-history-module-history-h-and-history-c-extra-credit-towards-your-exam-scores" title="Link to this heading">¶</a></h3>
<p>You will implement the <code class="docutils literal notranslate"><span class="pre">history</span></code> command/feature included in most shells. To get started, create and copy the following code into the <code class="docutils literal notranslate"><span class="pre">include/history.h</span></code> file:</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="cp">#ifndef _HISTORY_H_</span>
<span class="cp">#define _HISTORY_H_</span>

<span class="k">extern</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">HISTORY_FILE_PATH</span><span class="p">;</span>

<span class="c1">//Represents the state of the history of the shell</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">history</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">lines</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">max_history</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">next</span><span class="p">;</span>
<span class="p">}</span><span class="n">history_t</span><span class="p">;</span>


<span class="n">history_t</span><span class="w"> </span><span class="o">*</span><span class="nf">alloc_history</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">max_history</span><span class="p">);</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">add_line_history</span><span class="p">(</span><span class="n">history_t</span><span class="w"> </span><span class="o">*</span><span class="n">history</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">cmd_line</span><span class="p">);</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">print_history</span><span class="p">(</span><span class="n">history_t</span><span class="w"> </span><span class="o">*</span><span class="n">history</span><span class="p">);</span>

<span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="nf">find_line_history</span><span class="p">(</span><span class="n">history_t</span><span class="w"> </span><span class="o">*</span><span class="n">history</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">index</span><span class="p">);</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">free_history</span><span class="p">(</span><span class="n">history_t</span><span class="w"> </span><span class="o">*</span><span class="n">history</span><span class="p">);</span>

<span class="cp">#endif</span>
</pre></div>
</div>
<p>The header <strong>must</strong> contain the following definitions where you can add new fields but cannot delete or modify the function prototypes and types. <strong>Make sure to include a documentation header for each function prototype</strong>. To help you get started with the implementation file, create and copy the following code into the <code class="docutils literal notranslate"><span class="pre">src/history.c</span></code> file:</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;history.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string.h&gt;</span>

<span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">HISTORY_FILE_PATH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;../data/.msh_history&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p>The constant variable <code class="docutils literal notranslate"><span class="pre">HISTORY_FILE_PATH</span></code> contains the path to where you will store the history after the shell exits. You must use this variable in your implementation.</p>
<section id="alloc-history-function">
<h4><code class="docutils literal notranslate"><span class="pre">alloc_history</span></code> function<a class="headerlink" href="#alloc-history-function" title="Link to this heading">¶</a></h4>
<p>Most shells store the users history when they logout in a file under their home directory (e.g., your bash history is located here: <code class="docutils literal notranslate"><span class="pre">~/.bash_history</span></code>). For <code class="docutils literal notranslate"><span class="pre">msh</span></code>, you will create and store the history here: <code class="docutils literal notranslate"><span class="pre">data/.msh_history</span></code> (i.e., inside the <code class="docutils literal notranslate"><span class="pre">data</span></code> directory of your repository in a file named <code class="docutils literal notranslate"><span class="pre">msh_history</span></code>). The <code class="docutils literal notranslate"><span class="pre">alloc_history</span></code> function creates a new <code class="docutils literal notranslate"><span class="pre">history_t</span></code> state by</p>
<ol class="arabic simple">
<li><p>Allocating memory for a new <code class="docutils literal notranslate"><span class="pre">history_t</span></code> value.</p></li>
<li><p>Allocating memory for array of command line strings (<code class="docutils literal notranslate"><span class="pre">char</span> <span class="pre">**lines</span></code>). Make the size of this array equal to the <code class="docutils literal notranslate"><span class="pre">max_history</span></code> argument. The history must be ordered such that the oldest command line history starts at index zero to the most recent command line history being at the last empty index.</p></li>
<li><p>We recommend you make the <code class="docutils literal notranslate"><span class="pre">next</span></code> field of the <code class="docutils literal notranslate"><span class="pre">history_t</span></code> state point to the next available slot.</p></li>
<li><p>The function must also open the <code class="docutils literal notranslate"><span class="pre">HISTORY_FILE_PATH</span></code> file and load all prior history into <code class="docutils literal notranslate"><span class="pre">char</span> <span class="pre">**lines</span></code> <strong>up until</strong> <code class="docutils literal notranslate"><span class="pre">max_history</span></code> is reached. This means if <code class="docutils literal notranslate"><span class="pre">data/.msh_history</span></code> has 14 entries but now <code class="docutils literal notranslate"><span class="pre">max_history=5</span></code> then only the 5 oldest lines are loaded into <code class="docutils literal notranslate"><span class="pre">char</span> <span class="pre">**lines</span></code>.</p></li>
</ol>
<p>The function returns the allocated <code class="docutils literal notranslate"><span class="pre">history_t</span></code> state.</p>
</section>
<section id="add-line-history-function">
<h4><code class="docutils literal notranslate"><span class="pre">add_line_history</span></code> function<a class="headerlink" href="#add-line-history-function" title="Link to this heading">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">add_line_history</span></code> adds the parameter <code class="docutils literal notranslate"><span class="pre">cmd_line</span></code> to the history of lines. If <code class="docutils literal notranslate"><span class="pre">cmd_line</span></code> is empty then do not add it to the history. If the history of lines is full (i.e., all elements in <code class="docutils literal notranslate"><span class="pre">char</span> <span class="pre">**lines</span></code> is taken) then the function always deletes the oldest command line history (i.e., always at index 0). The function should shift all elements over by one and then insert the <code class="docutils literal notranslate"><span class="pre">cmd_line</span></code> at the last element in <code class="docutils literal notranslate"><span class="pre">char</span> <span class="pre">**lines</span></code>.</p>
<p><strong>Do not add the ``exit`` command to your history</strong>. The function must return if given <code class="docutils literal notranslate"><span class="pre">exit</span></code> and not add it to the history lines.</p>
</section>
<section id="print-history-function">
<h4><code class="docutils literal notranslate"><span class="pre">print_history</span></code> function<a class="headerlink" href="#print-history-function" title="Link to this heading">¶</a></h4>
<p>We provide the implementation of <code class="docutils literal notranslate"><span class="pre">print_history</span></code> below:</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">print_history</span><span class="p">(</span><span class="n">history_t</span><span class="w"> </span><span class="o">*</span><span class="n">history</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">history</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%5d</span><span class="se">\t</span><span class="s">%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">history</span><span class="o">-&gt;</span><span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="mi">-1</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Please use this implementation in your code. History listing always starts with 1-indexing similar to bash.</p>
</section>
<section id="find-line-history-function">
<h4><code class="docutils literal notranslate"><span class="pre">find_line_history</span></code> function<a class="headerlink" href="#find-line-history-function" title="Link to this heading">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">find_line_history</span></code> returns the command line at the specified <code class="docutils literal notranslate"><span class="pre">index</span></code>. If <code class="docutils literal notranslate"><span class="pre">index</span></code> is not within the range of <code class="docutils literal notranslate"><span class="pre">[1,max_history]</span></code> inclusive then the function returns <code class="docutils literal notranslate"><span class="pre">NULL</span></code>. History uses indexing starting at one but the <code class="docutils literal notranslate"><span class="pre">char</span> <span class="pre">**lines</span></code> start at zero-indexing so be mindful of this difference.</p>
</section>
<section id="free-history-function">
<h4><code class="docutils literal notranslate"><span class="pre">free_history</span></code> function<a class="headerlink" href="#free-history-function" title="Link to this heading">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">free_history</span></code> functions frees the <code class="docutils literal notranslate"><span class="pre">history_t</span></code> and all allocated memory associated with the state. However, before freeing the memory, the function must save all history inside the <code class="docutils literal notranslate"><span class="pre">char</span> <span class="pre">**lines</span></code> array to the <code class="docutils literal notranslate"><span class="pre">HISTORY_FILE_PATH</span></code> file. The oldest command line history starts at line one in the file until the most recent command line history at the end of the file.</p>
</section>
<section id="testing-the-history-module">
<h4>Testing the <code class="docutils literal notranslate"><span class="pre">history</span></code> module<a class="headerlink" href="#testing-the-history-module" title="Link to this heading">¶</a></h4>
<p>Professor Samuels will given you <code class="docutils literal notranslate"><span class="pre">test_history.c</span></code> file inside the Ed Post for Milestone #2. Place the <code class="docutils literal notranslate"><span class="pre">test_history.c</span></code> under the <code class="docutils literal notranslate"><span class="pre">tests</span></code> directory and compile and run it as follows:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>gcc<span class="w"> </span>-I../include/<span class="w"> </span>-o<span class="w"> </span>test_history<span class="w"> </span>test_history.c<span class="w"> </span>../src/history.c
<span class="gp">$ </span>./test_history
</pre></div>
</div>
</section>
<section id="update-the-evaluate-function">
<h4>Update the <code class="docutils literal notranslate"><span class="pre">evaluate</span></code> function<a class="headerlink" href="#update-the-evaluate-function" title="Link to this heading">¶</a></h4>
<p>Make sure to update the <code class="docutils literal notranslate"><span class="pre">evaluate</span></code> function to include the command lines coming into the evaluate function. Remember a command line as such: <code class="docutils literal notranslate"><span class="pre">ls</span> <span class="pre">-la</span> <span class="pre">.</span> <span class="pre">;</span> <span class="pre">sort</span> <span class="pre">bigfile</span> <span class="pre">&amp;</span> <span class="pre">cd</span> <span class="pre">..</span></code> counts as one history line and not three; although, there are three jobs on the line.</p>
</section>
</section>
<section id="task-3-built-in-commands">
<h3>Task 3: Built-in Commands<a class="headerlink" href="#task-3-built-in-commands" title="Link to this heading">¶</a></h3>
<p>Your <code class="docutils literal notranslate"><span class="pre">msh</span></code> must support a series of <strong>built-in</strong> shell commands. We recommend that you implement a function inside <code class="docutils literal notranslate"><span class="pre">shell.c</span></code> called <code class="docutils literal notranslate"><span class="pre">char</span> <span class="pre">*builtin_cmd(char</span> <span class="pre">**argv)</span></code> that takes in your <code class="docutils literal notranslate"><span class="pre">argv</span></code> array to handle processing any built-in commands. It returns a <code class="docutils literal notranslate"><span class="pre">char</span> <span class="pre">*</span></code> because the <code class="docutils literal notranslate"><span class="pre">!N</span></code> may want to return the chosen command line history. In all other cases, you can return <code class="docutils literal notranslate"><span class="pre">NULL</span></code> to indicate nothing additional should happen.</p>
<p>You must implement the following 6 built-in commands:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">jobs</span></code> command - The <code class="docutils literal notranslate"><span class="pre">jobs</span></code> command lists all the jobs currently active. It must look similar to Bash’s <code class="docutils literal notranslate"><span class="pre">jobs</span></code> command but with one slight difference. Each line must have the format: <code class="docutils literal notranslate"><span class="pre">[JOB_ID]</span> <span class="pre">PID</span> <span class="pre">STATE</span> <span class="pre">CMD_LINE</span></code>, where <code class="docutils literal notranslate"><span class="pre">JOB_ID</span></code> is the <code class="docutils literal notranslate"><span class="pre">int</span> <span class="pre">jid;</span></code> from the <code class="docutils literal notranslate"><span class="pre">job_t</span></code> entry,  <code class="docutils literal notranslate"><span class="pre">PID</span></code> is the process id for the job, <code class="docutils literal notranslate"><span class="pre">STATE</span></code> is either <code class="docutils literal notranslate"><span class="pre">RUNNING</span></code> if the job is currently running or <code class="docutils literal notranslate"><span class="pre">Stopped</span></code> if the job is currently suspended, and <code class="docutils literal notranslate"><span class="pre">CMD_LINE</span></code> is the full command line string for the job. For example, if the user enters in <code class="docutils literal notranslate"><span class="pre">/usr/bin/sort</span> <span class="pre">-n</span> <span class="pre">LARGE_NUM_FILE.txt</span> <span class="pre">&amp;</span></code> and its the first job entered with a <code class="docutils literal notranslate"><span class="pre">pid=2343</span></code> then its output would be: <code class="docutils literal notranslate"><span class="pre">[1]</span> <span class="pre">2343</span> <span class="pre">RUNNING</span> <span class="pre">/usr/bin/sort</span> <span class="pre">-n</span> <span class="pre">LARGE_NUM_FILE.txt</span></code>. In our <code class="docutils literal notranslate"><span class="pre">msh</span></code>, the only jobs you will see here are jobs that are background jobs or jobs that were suspended that could either be background or foreground jobs.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">history</span></code> command - Calls <code class="docutils literal notranslate"><span class="pre">print_history</span></code> to print the current shell history. <strong>Complete this built-in only after the optional history task. Only implement this if you are doing the extra credit. This must be implemented to get the full extra credit points.</strong></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">!N</span></code> command - This command is the history expansion command where <code class="docutils literal notranslate"><span class="pre">N</span></code> is a line number from the <code class="docutils literal notranslate"><span class="pre">history</span></code> command. The command reruns the <code class="docutils literal notranslate"><span class="pre">N</span></code> command from the user’s history list. <strong>Similiar to ``exit``, Do not add !N command to the history of the user</strong>. This command must display to the user the command that was chosen to be ran. The command line chosen must be executed again by the <code class="docutils literal notranslate"><span class="pre">evaluate</span></code> function. <strong>Complete this built-in only after the optional history task. Only implement this if you are doing the extra credit. This must be implemented to get the full extra credit points.</strong></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">bg</span> <span class="pre">&lt;job&gt;</span></code> command -  restarts <code class="docutils literal notranslate"><span class="pre">&lt;job&gt;</span></code> by sending it a <code class="docutils literal notranslate"><span class="pre">SIGCONT</span></code> signal, and then runs it in the background. The <code class="docutils literal notranslate"><span class="pre">&lt;job&gt;</span></code> argument can be either a PID or a JOB_ID (i.e., you specify it as <code class="docutils literal notranslate"><span class="pre">%JOB_ID</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">fg</span> <span class="pre">&lt;job&gt;</span></code> command - restarts <code class="docutils literal notranslate"><span class="pre">&lt;job&gt;</span></code> by sending it a <code class="docutils literal notranslate"><span class="pre">SIGCONT</span></code> signal, and then runs it in the foreground. The <code class="docutils literal notranslate"><span class="pre">&lt;job&gt;</span></code> argument can be either a PID or a JOB_ID (i.e., you specify it as <code class="docutils literal notranslate"><span class="pre">%JOB_ID</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">kill</span> <span class="pre">SIG_NUM</span> <span class="pre">PID</span></code> command - Calls the <code class="docutils literal notranslate"><span class="pre">kill</span></code> function, with <code class="docutils literal notranslate"><span class="pre">SIG_NUM</span></code> equal to either <code class="docutils literal notranslate"><span class="pre">2``(``SIGINT</span></code>), <code class="docutils literal notranslate"><span class="pre">9</span></code> (<code class="docutils literal notranslate"><span class="pre">SIGKILL</span></code>), <code class="docutils literal notranslate"><span class="pre">18``(``SIGCONT</span></code>), or <code class="docutils literal notranslate"><span class="pre">19``(``SIGSTOP</span></code>). Any other <code class="docutils literal notranslate"><span class="pre">SIG_NUM</span></code> number must produce the error message: <code class="docutils literal notranslate"><span class="pre">error:</span> <span class="pre">invalid</span> <span class="pre">signal</span> <span class="pre">number</span></code> to the user.</p></li>
</ol>
</section>
</section>
<section id="hints-tips">
<h2>Hints &amp; Tips<a class="headerlink" href="#hints-tips" title="Link to this heading">¶</a></h2>
<ul>
<li><p>When you implement your signal handlers, be sure to send <code class="docutils literal notranslate"><span class="pre">SIGINT</span></code> and <code class="docutils literal notranslate"><span class="pre">SIGTSTP</span></code> signals to the entire foreground process group, using <code class="docutils literal notranslate"><span class="pre">-pid</span></code> instead of <code class="docutils literal notranslate"><span class="pre">pid</span></code> in the argument to the kill function.</p></li>
<li><dl class="simple">
<dt>You now may want to define a function <code class="docutils literal notranslate"><span class="pre">waitfg</span></code> that waits for the foreground process to complete. One of the tricky parts of the assignment is deciding on the allocation of work between the <code class="docutils literal notranslate"><span class="pre">waitfg</span></code> and sigchld handler functions. We recommend the following approach:</dt><dd><ul class="simple">
<li><p>In <code class="docutils literal notranslate"><span class="pre">waitfg</span></code>, use a whilte(1) loop around the sleep function.</p></li>
<li><p>In <code class="docutils literal notranslate"><span class="pre">sigchldhandler</span></code>, use exactly one call to <code class="docutils literal notranslate"><span class="pre">waitpid</span></code>.</p></li>
</ul>
</dd>
</dl>
<p>While other solutions are possible, such as calling <code class="docutils literal notranslate"><span class="pre">waitpid</span></code> in both <code class="docutils literal notranslate"><span class="pre">waitfg</span></code> and <code class="docutils literal notranslate"><span class="pre">sigchld</span></code> handler, these can be very confusing. It is simpler to do all reaping in the handler.</p>
</li>
<li><p>In <code class="docutils literal notranslate"><span class="pre">evaluate</span></code>, the parent must use <code class="docutils literal notranslate"><span class="pre">sigprocmask</span></code> to block <code class="docutils literal notranslate"><span class="pre">SIGCHLD</span></code> signals before it forks the child, and then unblock these signals, again using <code class="docutils literal notranslate"><span class="pre">sigprocmask</span></code> after it adds the child to the job list by calling <code class="docutils literal notranslate"><span class="pre">add_job</span></code>. Since children inherit the blocked vectors of their parents, the child must be sure to then unblock <code class="docutils literal notranslate"><span class="pre">SIGCHLD</span></code> signals before it execs the new program.</p>
<p>The parent needs to block the <code class="docutils literal notranslate"><span class="pre">SIGCHLD</span></code> signals in this way in order to avoid the race condition where the child is reaped by <code class="docutils literal notranslate"><span class="pre">sigchld</span></code> handler (and thus removed from the job list) before the parent calls <code class="docutils literal notranslate"><span class="pre">add_job</span></code>.</p>
</li>
<li><p>Programs such as <code class="docutils literal notranslate"><span class="pre">more</span></code>, <code class="docutils literal notranslate"><span class="pre">less</span></code>, <code class="docutils literal notranslate"><span class="pre">vi</span></code>, and <code class="docutils literal notranslate"><span class="pre">emacs</span></code> do strange things with the terminal settings. Don’t run these programs from your shell. Stick with simple text-based programs such as <code class="docutils literal notranslate"><span class="pre">/bin/ls</span></code>, <code class="docutils literal notranslate"><span class="pre">/bin/ps</span></code>, and <code class="docutils literal notranslate"><span class="pre">/bin/echo</span></code> for testing purposes.</p></li>
<li><p>When you run your shell from the standard Unix shell, your shell is running in the foreground process group. If your shell then creates a child process, by default that child will also be a member of the foreground process group. Since typing ctrl-c sends a <code class="docutils literal notranslate"><span class="pre">SIGINT</span></code> to every process in the foreground group, typing ctrl-c will send a <code class="docutils literal notranslate"><span class="pre">SIGINT</span></code> to your shell, as well as to every process that your shell created, which obviously isn’t correct.</p>
<p>Here is the workaround: After the fork, but before the <code class="docutils literal notranslate"><span class="pre">execve</span></code>, the child process should call <code class="docutils literal notranslate"><span class="pre">setpgid(0,</span> <span class="pre">0)</span></code>, which puts the child in a new process group whose group ID is identical to the child’s PID. This ensures that there will be only one process, your shell, in the foreground process group. When you type ctrl-c, the shell should catch the resulting <code class="docutils literal notranslate"><span class="pre">SIGINT</span></code> and then forward it to the appropriate foreground job (or more precisely, the process group that contains the foreground job).</p>
</li>
</ul>
<section id="testing">
<h3>Testing<a class="headerlink" href="#testing" title="Link to this heading">¶</a></h3>
<p>We provide test code for testing the <code class="docutils literal notranslate"><span class="pre">history</span></code> feature of the shell inside. You can find these testcases in the upstream repository <code class="docutils literal notranslate"><span class="pre">hw-tests/milestone2</span></code>. Place this directory in the <code class="docutils literal notranslate"><span class="pre">tests</span></code> directory of your msh repository. These tests are almost the same as the milestone 1 tests but they also contain background processes. The history tests can be found in <code class="docutils literal notranslate"><span class="pre">hw-tests/test_history.c</span></code>. Please note We cannot provide other test cases easily for the remaining features (i.e., builtin commands).  We will have to test this by hand since the new features require user interaction.</p>
</section>
<section id="grading">
<h3>Grading<a class="headerlink" href="#grading" title="Link to this heading">¶</a></h3>
<p>Programming assignments will be graded according to a general rubric. Specifically, we will assign points for completeness, correctness, design, and style. (For more details on the categories, see our Assignment Rubric page.)</p>
<p>The exact weights for each category will vary from one assignment to another. For this assignment, the weights will be:</p>
<ul class="simple">
<li><p><strong>Completeness</strong>: 60%</p></li>
<li><p><strong>Correctness</strong>: 25%</p></li>
<li><p><strong>Design/Style</strong>: 15%</p></li>
</ul>
</section>
<section id="submission">
<h3>Submission<a class="headerlink" href="#submission" title="Link to this heading">¶</a></h3>
<p>Before submitting, make sure you’ve added, committed, and pushed all your code to GitHub. You must submit your final work through Gradescope (linked from our Canvas site) in the “Milestone #2” assignment page by linking your Github account to your Gradescope account and upload the correct repository based on the homework assignment. When you submit your homework, a pop window will appear. Click on “Github” and then  “Connect to Github” to connect your Github account to Gradescope. Once you connect (you will only need to do this once), then you can select the repository you wish to upload and the branch (which should always be “main” or “master”) for this course.</p>
<p>Depending on the assignment, once you submit your work, an “autograder” will run. This autograder should produce the same test results as when you run the code yourself; if it doesn’t, please let us know so we can look into it. A few other notes:</p>
<ul class="simple">
<li><p>You are allowed to make as many submissions as you want before the deadline.</p></li>
<li><p>Please make sure you have read and understood our <a class="reference internal" href="../../syllabus.html#late-submissions"><span class="std std-ref">Late Submission Policy</span></a>.</p></li>
<li><p>Your completeness score is determined solely based on the automated tests, but we may adjust your score if you attempt to pass tests by rote (e.g., by writing code that hard-codes the expected output for each possible test input).</p></li>
<li><p>Gradescope will report the test score it obtains when running your code. If there is a discrepancy between the score you get when running our grader script, and the score reported by Gradescope, please let us know so we can take a look at it.</p></li>
</ul>
</section>
</section>
</section>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2021-2025, University of Chicago.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 7.3.7.<br/>
    </p>
  </div>
</footer>
  </body>
</html>